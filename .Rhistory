source('~/Documents/covid-unvaccinated-aimpaper/analysis/01_data_process.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/analysis/01_data_process.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/analysis/02_summary_tables.R', echo=TRUE)
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message = FALSE, warning = FALSE)
dir.create(here::here("output", "report"), showWarnings = FALSE, recursive=TRUE)
library(tidyverse)
library(glue)
library(readr)
library(flextable)
source(here::here("analysis", "lib", "sanitise_variables.R"))
my_flextable_1 <- function(.data) {
.data %>%
flextable() %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
}
read_csv(here::here("output", "tables", "elig_dates_tibble.csv")) %>%
my_flextable_1()
bind_rows(
read_csv(here::here("output", "tables", glue("death_count_02.csv"))) %>% mutate(jcvi_group="02"),
read_csv(here::here("output", "tables", glue("death_count_09.csv"))) %>% mutate(jcvi_group="09"),
read_csv(here::here("output", "tables", glue("death_count_11.csv"))) %>% mutate(jcvi_group="11")
) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
group_by(jcvi_group) %>%
rename(Unvaccinated="0", Vaccinated="1") %>%
mutate(
across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(., accuracy = 1), " (", round(100*./sum(.),0), ")"))
) %>%
ungroup() %>%
mutate(
across(died_during,
~if_else(. == "0", "Included", "Excluded due to death during eligibility period")
)) %>%
select(`JCVI Group` = jcvi_group, Status = died_during, everything()) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("output", "tables", glue("summary_table_{g}.csv"))) %>%
# full_join(
#   read_rds(file = here::here("output", "tables", glue("table_{g}_unadj.rds"))) %>%
# rename(Characteristic = characteristic,
#        "OR (95% CI)" = OR)
# ) %>%
my_flextable_1()
source('~/Documents/covid-unvaccinated-aimpaper/analysis/03_model.R', echo=TRUE)
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message = FALSE, warning = FALSE)
dir.create(here::here("output", "report"), showWarnings = FALSE, recursive=TRUE)
library(tidyverse)
library(glue)
library(readr)
library(flextable)
source(here::here("analysis", "lib", "sanitise_variables.R"))
my_flextable_1 <- function(.data) {
.data %>%
flextable() %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
}
read_csv(here::here("output", "tables", "elig_dates_tibble.csv")) %>%
my_flextable_1()
bind_rows(
read_csv(here::here("output", "tables", glue("death_count_02.csv"))) %>% mutate(jcvi_group="02"),
read_csv(here::here("output", "tables", glue("death_count_09.csv"))) %>% mutate(jcvi_group="09"),
read_csv(here::here("output", "tables", glue("death_count_11.csv"))) %>% mutate(jcvi_group="11")
) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
group_by(jcvi_group) %>%
rename(Unvaccinated="0", Vaccinated="1") %>%
mutate(
across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(., accuracy = 1), " (", round(100*./sum(.),0), ")"))
) %>%
ungroup() %>%
mutate(
across(died_during,
~if_else(. == "0", "Included", "Excluded due to death during eligibility period")
)) %>%
select(`JCVI Group` = jcvi_group, Status = died_during, everything()) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_rds(file = here::here("output", "tables", glue("table_{g}_unadj.rds"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
# # # # # # # # # # # # # # # # # # # # #
# This script:
# fits survival model where an event is vaccination after eligibility period
# time 0 is elig_date + 12 weeks
# stratified by group, specified in args (see below)
# plots cumulative incidence
#
# The script should be run via an action in the project.yaml
# The script must be accompanied by one argument:
# 1. jcvi_group or elig_date, the strata for the survival model
# # # # # # # # # # # # # # # # # # # # #
cat("#### import command-line arguments ####\n")
args <- commandArgs(trailingOnly=TRUE)
if(length(args)==0){
# use for interactive testing
group <- "jcvi_group"
} else {
group <- args[[1]]
}
## packages
library(tidyverse)
library(RColorBrewer)
library(glue)
library(survival)
library(survminer)
## Create output directory
dir.create(here::here("output", "models"), showWarnings = FALSE, recursive=TRUE)
dir.create(here::here("output", "figures"), showWarnings = FALSE, recursive=TRUE)
all_variables <- readr::read_rds(here::here("analysis", "lib", "all_variables.rds"))
cat("#### bind processed datasets ####\n")
data_survival <- bind_rows(
read_rds(here::here("output", "data", glue("data_processed_02.rds"))),
read_rds(here::here("output", "data", glue("data_processed_09.rds"))),
read_rds(here::here("output", "data", glue("data_processed_11.rds")))
) %>%
filter(vax_12 == "0") %>%
select(all_variables$id_vars, all_variables$survival_vars) %>%
# time in weeks instead of days
mutate(time = time/7)
cat("#### process args ####\n")
get_strata <- function(g) {
out <- data_survival %>%
rename(var = g) %>%
distinct(var) %>%
arrange(var) %>%
unlist() %>%
unname()
out <- str_remove(out, "^0")
return(out)
}
strata <- get_strata(group)
title <- if_else(group == "jcvi_group", "JCVI Group", "Eligibility date")
cat("#### fit survival model ####\n")
fit <- survfit(as.formula(glue("Surv(time, status) ~ {group}")),
data = data_survival)
write_rds(fit, here::here("output", "models", glue("surv_model_{group}.rds")))
cat("#### generate plots ####\n")
# Plot cumulative events
survplots <- ggsurvplot(fit,
break.time.by = 4,
xlim = c(0,max(data_survival$time)),
conf.int = TRUE,
palette = brewer.pal(n = length(strata), name = "Dark2"),
censor=FALSE, #don't show censor ticks on line
cumevents = TRUE,
cumcensor = TRUE,
risk.table.col = "strata",
fun = "event",
# aesthetics
xlab = "Time since end of eligibility period (weeks)",
legend.title = title,
legend.labs = strata,
ggtheme = theme_bw())
survplots$cumevents
survplots$data.survplot
survplots$data.survtable
survplots$cumevents
survplots$cumevents +
theme(text = element_text(size=8))
survplots$cumevents +
geom_text(size=8)
survplots$cumevents +
geom_label(size=8)
ggpubr::ggpar(survplots$cumevents,
font.title = list(size = 10, color = "blue", face = "italic"))
survplots$plot,
survplots$plot
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message = FALSE, warning = FALSE)
dir.create(here::here("output", "report"), showWarnings = FALSE, recursive=TRUE)
library(tidyverse)
library(glue)
library(readr)
library(flextable)
source(here::here("analysis", "lib", "sanitise_variables.R"))
my_flextable_1 <- function(.data) {
.data %>%
flextable() %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
}
read_csv(here::here("output", "tables", "elig_dates_tibble.csv")) %>%
my_flextable_1()
bind_rows(
read_csv(here::here("output", "tables", glue("death_count_02.csv"))) %>% mutate(jcvi_group="02"),
read_csv(here::here("output", "tables", glue("death_count_09.csv"))) %>% mutate(jcvi_group="09"),
read_csv(here::here("output", "tables", glue("death_count_11.csv"))) %>% mutate(jcvi_group="11")
) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
group_by(jcvi_group) %>%
rename(Unvaccinated="0", Vaccinated="1") %>%
mutate(
across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(., accuracy = 1), " (", round(100*./sum(.),0), ")"))
) %>%
ungroup() %>%
mutate(
across(died_during,
~if_else(. == "0", "Included", "Excluded due to death during eligibility period")
)) %>%
select(`JCVI Group` = jcvi_group, Status = died_during, everything()) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
read_csv(here::here("output", "tables", "elig_dates_tibble.csv")) %>%
my_flextable_1()
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message = FALSE, warning = FALSE)
dir.create(here::here("output", "report"), showWarnings = FALSE, recursive=TRUE)
library(tidyverse)
library(glue)
library(readr)
library(flextable)
source(here::here("analysis", "lib", "sanitise_variables.R"))
my_flextable_1 <- function(.data) {
.data %>%
flextable() %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
}
read_csv(here::here("output", "tables", "elig_dates_tibble.csv")) %>%
my_flextable_1()
bind_rows(
read_csv(here::here("output", "tables", glue("death_count_02.csv"))) %>% mutate(jcvi_group="02"),
read_csv(here::here("output", "tables", glue("death_count_09.csv"))) %>% mutate(jcvi_group="09"),
read_csv(here::here("output", "tables", glue("death_count_11.csv"))) %>% mutate(jcvi_group="11")
) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
group_by(jcvi_group) %>%
rename(Unvaccinated="0", Vaccinated="1") %>%
mutate(
across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(., accuracy = 1), " (", round(100*./sum(.),0), ")"))
) %>%
ungroup() %>%
mutate(
across(died_during,
~if_else(. == "0", "Included", "Excluded due to death during eligibility period")
)) %>%
select(`JCVI Group` = jcvi_group, Status = died_during, everything()) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
source('~/Documents/covid-unvaccinated-aimpaper/create_project.R', echo=TRUE)
rn(list = ls9)
rn(list = ls())
rm(list = ls())
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message = FALSE, warning = FALSE)
dir.create(here::here("output", "report"), showWarnings = FALSE, recursive=TRUE)
library(tidyverse)
library(glue)
library(readr)
library(flextable)
source(here::here("analysis", "lib", "sanitise_variables.R"))
my_flextable_1 <- function(.data) {
.data %>%
flextable() %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
}
bind_rows(
read_csv(here::here("output", "tables", glue("death_count_02.csv"))) %>% mutate(jcvi_group="02"),
read_csv(here::here("output", "tables", glue("death_count_09.csv"))) %>% mutate(jcvi_group="09"),
read_csv(here::here("output", "tables", glue("death_count_11.csv"))) %>% mutate(jcvi_group="11")
) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
group_by(jcvi_group) %>%
rename(Unvaccinated="0", Vaccinated="1") %>%
mutate(
across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(., accuracy = 1), " (", round(100*./sum(.),0), ")"))
) %>%
ungroup() %>%
mutate(
across(died_during,
~if_else(. == "0", "Included", "Excluded due to death during eligibility period")
)) %>%
select(`JCVI Group` = jcvi_group, Status = died_during, everything()) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
g <- "09"
read_csv(here::here("output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
g <- "11"
read_csv(here::here("output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message = FALSE, warning = FALSE)
# dir.create(here::here("output", "report"), showWarnings = FALSE, recursive=TRUE)
library(tidyverse)
library(glue)
library(readr)
library(flextable)
source(here::here("analysis", "lib", "sanitise_variables.R"))
my_flextable_1 <- function(.data) {
.data %>%
flextable() %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
}
read_csv(here::here("released_outputs", "output", "tables", "elig_dates_tibble.csv")) %>%
my_flextable_1()
read_csv(here::here("released_outputs", "output", "tables", "elig_dates_tibble.csv")) %>%
arrange(elig_date) %>%
rename("JCVI group"=jcvi_group, "Age band"=ageband, "Eligibility date"=elig_date) %>%
my_flextable_1()
bind_rows(
read_csv(here::here("released_outputs", "output", "tables", glue("death_count_02.csv"))) %>% mutate(jcvi_group="02"),
read_csv(here::here("released_outputs", "output", "tables", glue("death_count_09.csv"))) %>% mutate(jcvi_group="09"),
read_csv(here::here("released_outputs", "output", "tables", glue("death_count_11.csv"))) %>% mutate(jcvi_group="11")
) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
group_by(jcvi_group) %>%
rename(Unvaccinated="0", Vaccinated="1") %>%
mutate(
across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(., accuracy = 1), " (", round(100*./sum(.),0), ")"))
) %>%
ungroup() %>%
mutate(
across(died_during,
~if_else(. == "0", "Included", "Excluded due to death during eligibility period")
)) %>%
select(`JCVI Group` = jcvi_group, Status = died_during, everything()) %>%
my_flextable_1()
bind_rows(
read_csv(here::here("released_outputs", "output", "tables", glue("death_count_02.csv"))) %>% mutate(jcvi_group="02"),
read_csv(here::here("released_outputs", "output", "tables", glue("death_count_09.csv"))) %>% mutate(jcvi_group="09"),
# read_csv(here::here("released_outputs", "output", "tables", glue("death_count_11.csv"))) %>% mutate(jcvi_group="11")
) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
group_by(jcvi_group) %>%
rename(Unvaccinated="0", Vaccinated="1") %>%
mutate(
across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(., accuracy = 1), " (", round(100*./sum(.),0), ")"))
) %>%
ungroup() %>%
mutate(
across(died_during,
~if_else(. == "0", "Included", "Excluded due to death during eligibility period")
)) %>%
select(`JCVI Group` = jcvi_group, Status = died_during, everything()) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
g <- "09"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
g <- "11"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
mutate(
across(Characteristic,
~case_when(. %in% "Age" ~ "Age: mean (SD)",
. %in% "n (% of sample)" ~ "n (rowwise %)",
TRUE ~ .))
) %>%
my_flextable_1()
survtable_jcvi_group <- readr::read_csv(here::here("released_outputs", "output", "tables", "survtable_jcvi_group.csv"))
survtable_jcvi_group
survtable_jcvi_group %>%
ggplot(aes(x=time, colour=strata, y=pct.risk)) +
geom_step()
survtable_jcvi_group %>%
select(jcvi_group, cum.n.event)
survtable_jcvi_group %>%
select(jcvi_group, time, cum.n.event)
survtable_jcvi_group %>%
select(jcvi_group, time, cum.n.event) %>%
pivot_longer(names_from = "jcvi_group", values_from = "cum.n.event")
survtable_jcvi_group %>%
select(jcvi_group, time, cum.n.event) %>%
pivot_wdier(names_from = "jcvi_group", values_from = "cum.n.event")
survtable_jcvi_group %>%
select(jcvi_group, time, cum.n.event) %>%
pivot_wider(names_from = "jcvi_group", values_from = "cum.n.event")
# # # # # # # # # # # # # # # # # # # # #
# This script:
# generates a summary table of all variables for each of the jcvi groups included
#
# The script should be run via an action in the project.yaml
# The script must be accompanied by one argument:
# 1. JCVI group: 02, 09 or 11
# # # # # # # # # # # # # # # # # # # # #
cat("#### import command-line arguments ####\n")
args <- commandArgs(trailingOnly=TRUE)
if(length(args)==0){
# use for interactive testing
jcvi_group <- "02"
} else {
jcvi_group <- args[[1]]
}
# libraries
library(tidyverse)
library(readr)
library(scales)
library(glue)
dir.create(here::here("output", "tables"), showWarnings = FALSE, recursive=TRUE)
cat("#### import custom functions ####\n")
source(here::here("analysis", "lib", "sanitise_variables.R"))
source(here::here("analysis", "lib", "mask.R"))
all_variables <- readr::read_rds(here::here("analysis", "lib", "all_variables.rds"))
cat("#### load data for jcvi_group ####\n")
data <- read_rds(here::here("output", "data", glue("data_processed_{jcvi_group}.rds")))
cat("#### get names of variable with levels 0 and 1 ####\n")
levs2 <- sapply(names(data),
function(x) if_else(all(levels(data[,x][[1]]) %in% c("0","1")),
TRUE, FALSE))
x <- "sex"
data %>%
group_by(weight, vax_12, .data[[x]]) %>%
count() %>%
ungroup(weight, .data[[x]]) %>%
# mask values < 5
mask(n) %>%
# use inverse probability weighting to correct for random sampling
mutate(across(n, ~weight*n)) %>%
select(-weight)
data %>%
group_by(weight, vax_12, .data[[x]]) %>%
count() %>%
ungroup(weight, .data[[x]]) %>%
# mask values < 5
mask(n) %>%
# use inverse probability weighting to correct for random sampling
mutate(across(n, ~weight*n)) %>%
select(-weight) %>%
# mutate(value = str_c(comma(n, accuracy = 1), " (", round(100*n/sum(n),1), ")")) %>%
ungroup() %>%
select(vax_12, .data[[x]], value) %>%
pivot_wider(names_from = vax_12, values_from = value)
