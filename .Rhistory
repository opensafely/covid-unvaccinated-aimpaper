mask(n) %>%
# use inverse probability weighting to correct for random sampling
mutate(across(n, ~weight*n)) %>%
select(-weight) %>%
ungroup() %>%
select(vax_12, .data[[x]], n) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
# replace NA with 0
mutate(across(c(`0`, `1`), ~if_else(is.na(.), 0, .))) %>%
mutate(across(c(`0`, `1`),
~str_c(comma(., accuracy = 1), " (", round(100*./(`0`+`1`),1), ")"))) %>%
mutate(variable = x,
category = as.character(.data[[x]])) %>%
select(variable, category, `0`, `1`)
)
)  %>%
select(variable, category, unvaccinated = `0`, vaccinated = `1`) %>%
# keep only one level if binary
mutate(across(category,
~case_when(
variable %in% names(data)[levs2]
& . %in% "0"
~ "REMOVE",
variable %in% names(data)[levs2]
& . %in% "1"
~ "",
TRUE ~ .))) %>%
filter(!(category %in% "REMOVE")) %>%
# clean text in columns
sanitise_variables(variable) %>%
mutate(characteristic = case_when(
category %in% "" | is.na(category)
~ variable,
TRUE
~ str_c(variable, category, sep = ": "))) %>%
select(characteristic, unvaccinated, vaccinated) %>%
# filter(characteristic != "Sex: M") %>%
rename_with(str_to_sentence)
summary_table
summary_table %>% print(n=Inf)
source('~/Documents/covid-unvaccinated-aimpaper/analysis/04_cumulative_incidence.R', echo=TRUE)
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message = FALSE, warning = FALSE)
# dir.create(here::here("output", "report"), showWarnings = FALSE, recursive=TRUE)
library(tidyverse)
library(glue)
library(readr)
library(flextable)
source(here::here("analysis", "lib", "sanitise_variables.R"))
my_flextable_1 <- function(.data) {
.data %>%
flextable() %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
}
read_csv(here::here("released_outputs", "output", "tables", "elig_dates_tibble.csv")) %>%
arrange(elig_date) %>%
rename("JCVI group"=jcvi_group, "Age band"=ageband, "Eligibility date"=elig_date) %>%
my_flextable_1()
bind_rows(
read_csv(here::here("released_outputs", "output", "tables", glue("death_count_02.csv"))) %>% mutate(jcvi_group="02"),
read_csv(here::here("released_outputs", "output", "tables", glue("death_count_09.csv"))) %>% mutate(jcvi_group="09"),
# read_csv(here::here("released_outputs", "output", "tables", glue("death_count_11.csv"))) %>% mutate(jcvi_group="11")
) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
group_by(jcvi_group) %>%
rename(Unvaccinated="0", Vaccinated="1") %>%
mutate(
across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(., accuracy = 1), " (", round(100*./sum(.),0), ")"))
) %>%
ungroup() %>%
mutate(
across(died_during,
~if_else(. == "0", "Included", "Excluded due to death during eligibility period")
)) %>%
select(`JCVI Group` = jcvi_group, Status = died_during, everything()) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
mutate(
across(Characteristic,
~case_when(. %in% "Age" ~ "Age: mean (SD)",
. %in% "n (% of sample)" ~ "n (rowwise %)",
TRUE ~ .))
) %>%
my_flextable_1()
g <- "09"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
mutate(
across(Characteristic,
~case_when(. %in% "Age" ~ "Age: mean (SD)",
. %in% "n (% of sample)" ~ "n (rowwise %)",
TRUE ~ .))
) %>%
my_flextable_1()
g <- "11"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
mutate(
across(Characteristic,
~case_when(. %in% "Age" ~ "Age: mean (SD)",
. %in% "n (% of sample)" ~ "n (rowwise %)",
TRUE ~ .))
) %>%
my_flextable_1()
survtable_jcvi_group <- readr::read_csv(here::here("released_outputs", "output", "tables", "survtable_jcvi_group.csv"))
survtable_jcvi_group
survtable_jcvi_group %>%
select(jcvi_group, time, cum.n.event) %>%
pivot_wider(names_from = "jcvi_group", values_from = "cum.n.event")
survtable_jcvi_group <- readr::read_csv(here::here("released_outputs", "output", "tables", "survtable_jcvi_group.csv"))
survtable_jcvi_group <- readr::read_csv(here::here("released_outputs", "output", "tables", "survtable_elig_date.csv"))
survtable_jcvi_group <- readr::read_csv(here::here("released_outputs", "output", "tables", "survtable_jcvi_group.csv"))
survtable_elig_date <- readr::read_csv(here::here("released_outputs", "output", "tables", "survtable_elig_date.csv"))
survtable_jcvi_group %>%
select(jcvi_group, time, cum.n.event) %>%
pivot_wider(names_from = "jcvi_group", values_from = "cum.n.event") %>%
select("JCVI Group" = jcvi_group,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
survtable_jcvi_group %>%
# select(jcvi_group, time, cum.n.event) %>%
# pivot_wider(names_from = "jcvi_group", values_from = "cum.n.event") %>%
select("JCVI Group" = jcvi_group,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
survtable_jcvi_group %>%
# select(jcvi_group, time, cum.n.event) %>%
# pivot_wider(names_from = "jcvi_group", values_from = "cum.n.event") %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
survtable_jcvi_group %>%
filter(jcvi_group=="02") %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
survtable_jcvi_group %>%
filter(jcvi_group=="02") %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1()
for (group %in% c("02", "09", "11")) {
for (group %in% c("02", "09", "11")) {
for (group in c("02", "09", "11")) {
survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1()
}
for (group in c("02", "09", "11")) {
survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1() %>%
print()
}
for (group in unique(survtable_jcvi_group$elig_date)) {
survtable_elig_date %>%
filter(elig_date==group) %>%
select("Eligibility date" = elig_date,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1() %>%
print()
}
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group[[group]] %>% my_flextable_1()
out_jcvi_group[["02"]] %>% my_flextable_1()
out_jcvi_group[["09"]] %>% my_flextable_1()
out_jcvi_group[["11"]] %>% my_flextable_1()
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
fitler(lag(n.risk>0)) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
filter(lag(n.risk>0)) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group[["09"]] %>% my_flextable_1()
out_jcvi_group[["11"]] %>% my_flextable_1()
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
# filter(lag(n.risk>0)) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
filter(lag(n.risk>0)|time==0) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group[["02"]] %>% my_flextable_1()
out_jcvi_group[["09"]] %>% my_flextable_1()
out_jcvi_group[["11"]] %>% my_flextable_1()
groups <- unique(survtable_elig_date$elig_date)
groups
survtable_elig_date %>%
filter(lag(n.risk>0)|time==0) %>%
select("Eligibilty date" = elig_date,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1()
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>%
select("JCVI group" = elig_date,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1()
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>%
select("JCVI group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1()
g <- "02"
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv")))
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristis, "COVID"))
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID"))
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(g = OR)
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
left_join(tables_list[["09"]]) %>%
left_join(tables_list[["11"]])
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
left_join(tables_list[["09"]]) %>%
left_join(tables_list[["11"]]) %>%
flextable() %>%
add_header_row(
values = c("", "Odds ratio of JCVI group:"),
colwidths = c(1, 3)) %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
left_join(tables_list[["09"]]) %>%
left_join(tables_list[["11"]]) %>%
rename(Characteristic=characteristic) %>%
flextable() %>%
add_header_row(
values = c("", "Odds ratio of JCVI group:"),
colwidths = c(1, 3)) %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
as.Date("2021-05-26") + lubridate::weeks(12)
as.Date("2021-05-26") + lubridate::weeks(16)
survtable_jcvi_group
survtable_jcvi_group %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=jcvi_group)) +
geom_step()
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=jcvi_group)) +
geom_step()
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0)
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>% mutate(test=cum.n.event/n.risk)
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>% mutate(test=1-cum.n.event/n.risk)
survtable_jcvi_group %>%
filter(n.risk>0) %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=jcvi_group)) +
geom_step()
survtable_jcvi_group %>%
filter(n.risk>0)
survtable_jcvi_group %>%
filter(n.risk>0) %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=jcvi_group)) +
geom_point() +
geom_step()
survtable_elig_date %>%
filter(n.risk>0) %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=elig_date)) +
geom_point() +
geom_step()
survtable_elig_date %>%
filter(n.risk>0) %>%
mutate(across(elig_date, as.factor)) +
ggplot(aes(y= 100-pct.risk,x=time, colour=elig_date)) +
geom_point() +
geom_step()
survtable_elig_date %>%
filter(n.risk>0) %>%
mutate(across(elig_date, as.factor))  %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=elig_date)) +
geom_point() +
geom_step()
fit<- survfit(Surv(time, status) ~ sex, data = lung)
# Drawing survival curves
ggsurvplot(fit)
library(survminer)
fit<- survfit(Surv(time, status) ~ sex, data = lung)
# Drawing survival curves
ggsurvplot(fit)
library(survival)
library(survminer)
fit<- survfit(Surv(time, status) ~ sex, data = lung)
# Drawing survival curves
ggsurvplot(fit)
# Drawing survival curves
ggsurvplot(fit, fun="event")
# Drawing survival curves
p <- ggsurvplot(fit, fun="event")
p$data.survplot
p$data.survtable
p$data.survtable %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=sex)) +
geom_point() +
geom_step()
# Drawing survival curves
p1 <- ggsurvplot(fit, fun="event")
p2 <- p$data.survtable %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=sex)) +
geom_point() +
geom_step()
cowplot::plot_grid(p1,p2)
cowplot::plot_grid(p1$plot,p2)
cowplot::plot_grid(p1$plot,p2) +
geom_point(data = p$data.survtable, aes(y= 100-pct.risk,x=time, colour=sex)) +
geom_point() +
geom_step()
p1$plot +
geom_point(data = p$data.survtable, aes(y= 100-pct.risk,x=time, colour=sex)) +
geom_point() +
geom_step()
cowplot::plot_grid(p1$plot,p2)
p1$data.survtable
p1$data.survplot
v
g <- "02"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
)
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\s\(\d+\)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\\s\(\\d+\)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\\s(\\d+)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\\s\\(\\d+\\)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\\s\\(.+\\)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~case_when(
Characteristic %in% "Age"
~ .,
TRUE
~ str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)
))
)
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~case_when(
Characteristic %in% "Age"
~ .,
TRUE
~ str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(.), "(", round(100*./(Unvaccinated + Vaccinated), 1) ")")
))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~case_when(
Characteristic %in% "Age"
~ .,
TRUE
~ str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)))) %>%
mutate(total=Unvaccinated + Vaccinated) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(.),
"(", round(100*./(total), 1) ")")
))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~case_when(
Characteristic %in% "Age"
~ .,
TRUE
~ str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(.),
"(", round(100*./(Unvaccinated + Vaccinated), 1), ")")
))
