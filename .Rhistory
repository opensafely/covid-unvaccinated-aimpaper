survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1() %>%
print()
}
for (group in unique(survtable_jcvi_group$elig_date)) {
survtable_elig_date %>%
filter(elig_date==group) %>%
select("Eligibility date" = elig_date,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1() %>%
print()
}
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group[[group]] %>% my_flextable_1()
out_jcvi_group[["02"]] %>% my_flextable_1()
out_jcvi_group[["09"]] %>% my_flextable_1()
out_jcvi_group[["11"]] %>% my_flextable_1()
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
fitler(lag(n.risk>0)) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
filter(lag(n.risk>0)) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group[["09"]] %>% my_flextable_1()
out_jcvi_group[["11"]] %>% my_flextable_1()
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
# filter(lag(n.risk>0)) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group <- list()
for (group in unique(survtable_jcvi_group$jcvi_group)) {
out_jcvi_group[[group]] <- survtable_jcvi_group %>%
filter(jcvi_group==group) %>%
filter(lag(n.risk>0)|time==0) %>%
select("JCVI Group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor)
}
out_jcvi_group[["02"]] %>% my_flextable_1()
out_jcvi_group[["09"]] %>% my_flextable_1()
out_jcvi_group[["11"]] %>% my_flextable_1()
groups <- unique(survtable_elig_date$elig_date)
groups
survtable_elig_date %>%
filter(lag(n.risk>0)|time==0) %>%
select("Eligibilty date" = elig_date,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1()
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>%
select("JCVI group" = elig_date,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1()
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>%
select("JCVI group" = jcvi_group,
"Time" = time,
"N at risk" = n.risk,
"N events" = n.event,
"N censor" = n.censor) %>%
my_flextable_1()
g <- "02"
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv")))
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristis, "COVID"))
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID"))
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(g = OR)
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
left_join(tables_list[["09"]]) %>%
left_join(tables_list[["11"]])
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
left_join(tables_list[["09"]]) %>%
left_join(tables_list[["11"]]) %>%
flextable() %>%
add_header_row(
values = c("", "Odds ratio of JCVI group:"),
colwidths = c(1, 3)) %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
left_join(tables_list[["09"]]) %>%
left_join(tables_list[["11"]]) %>%
rename(Characteristic=characteristic) %>%
flextable() %>%
add_header_row(
values = c("", "Odds ratio of JCVI group:"),
colwidths = c(1, 3)) %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
as.Date("2021-05-26") + lubridate::weeks(12)
as.Date("2021-05-26") + lubridate::weeks(16)
survtable_jcvi_group
survtable_jcvi_group %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=jcvi_group)) +
geom_step()
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=jcvi_group)) +
geom_step()
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0)
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>% mutate(test=cum.n.event/n.risk)
survtable_jcvi_group %>%
filter(lag(n.risk>0)|time==0) %>% mutate(test=1-cum.n.event/n.risk)
survtable_jcvi_group %>%
filter(n.risk>0) %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=jcvi_group)) +
geom_step()
survtable_jcvi_group %>%
filter(n.risk>0)
survtable_jcvi_group %>%
filter(n.risk>0) %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=jcvi_group)) +
geom_point() +
geom_step()
survtable_elig_date %>%
filter(n.risk>0) %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=elig_date)) +
geom_point() +
geom_step()
survtable_elig_date %>%
filter(n.risk>0) %>%
mutate(across(elig_date, as.factor)) +
ggplot(aes(y= 100-pct.risk,x=time, colour=elig_date)) +
geom_point() +
geom_step()
survtable_elig_date %>%
filter(n.risk>0) %>%
mutate(across(elig_date, as.factor))  %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=elig_date)) +
geom_point() +
geom_step()
fit<- survfit(Surv(time, status) ~ sex, data = lung)
# Drawing survival curves
ggsurvplot(fit)
library(survminer)
fit<- survfit(Surv(time, status) ~ sex, data = lung)
# Drawing survival curves
ggsurvplot(fit)
library(survival)
library(survminer)
fit<- survfit(Surv(time, status) ~ sex, data = lung)
# Drawing survival curves
ggsurvplot(fit)
# Drawing survival curves
ggsurvplot(fit, fun="event")
# Drawing survival curves
p <- ggsurvplot(fit, fun="event")
p$data.survplot
p$data.survtable
p$data.survtable %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=sex)) +
geom_point() +
geom_step()
# Drawing survival curves
p1 <- ggsurvplot(fit, fun="event")
p2 <- p$data.survtable %>%
ggplot(aes(y= 100-pct.risk,x=time, colour=sex)) +
geom_point() +
geom_step()
cowplot::plot_grid(p1,p2)
cowplot::plot_grid(p1$plot,p2)
cowplot::plot_grid(p1$plot,p2) +
geom_point(data = p$data.survtable, aes(y= 100-pct.risk,x=time, colour=sex)) +
geom_point() +
geom_step()
p1$plot +
geom_point(data = p$data.survtable, aes(y= 100-pct.risk,x=time, colour=sex)) +
geom_point() +
geom_step()
cowplot::plot_grid(p1$plot,p2)
p1$data.survtable
p1$data.survplot
v
g <- "02"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
)
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\s\(\d+\)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\\s\(\\d+\)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\\s(\\d+)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\\s\\(\\d+\\)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove(., "\\s\\(.+\\)")))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~case_when(
Characteristic %in% "Age"
~ .,
TRUE
~ str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)
))
)
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~case_when(
Characteristic %in% "Age"
~ .,
TRUE
~ str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(.), "(", round(100*./(Unvaccinated + Vaccinated), 1) ")")
))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~case_when(
Characteristic %in% "Age"
~ .,
TRUE
~ str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)))) %>%
mutate(total=Unvaccinated + Vaccinated) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(.),
"(", round(100*./(total), 1) ")")
))
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~case_when(
Characteristic %in% "Age"
~ .,
TRUE
~ str_remove_all(
str_remove(., "\\s\\(.+\\)"),
","
)))) %>%
mutate(across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(.),
"(", round(100*./(Unvaccinated + Vaccinated), 1), ")")
))
knitr::opts_chunk$set(echo = FALSE, include=FALSE, message = FALSE, warning = FALSE)
# dir.create(here::here("output", "report"), showWarnings = FALSE, recursive=TRUE)
library(tidyverse)
library(glue)
library(readr)
library(flextable)
source(here::here("analysis", "lib", "sanitise_variables.R"))
my_flextable_1 <- function(.data) {
.data %>%
flextable() %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
}
read_csv(here::here("released_outputs", "output", "tables", "elig_dates_tibble.csv")) %>%
arrange(elig_date) %>%
rename("JCVI group"=jcvi_group, "Age band"=ageband, "Eligibility date"=elig_date) %>%
my_flextable_1()
bind_rows(
read_csv(here::here("released_outputs", "output", "tables", glue("death_count_02.csv"))) %>% mutate(jcvi_group="02"),
read_csv(here::here("released_outputs", "output", "tables", glue("death_count_09.csv"))) %>% mutate(jcvi_group="09"),
# read_csv(here::here("released_outputs", "output", "tables", glue("death_count_11.csv"))) %>% mutate(jcvi_group="11")
) %>%
pivot_wider(names_from = vax_12, values_from = n) %>%
group_by(jcvi_group) %>%
rename(Unvaccinated="0", Vaccinated="1") %>%
mutate(
across(c(Unvaccinated, Vaccinated),
~str_c(scales::comma(., accuracy = 1), " (", round(100*./sum(.),0), ")"))
) %>%
ungroup() %>%
mutate(
across(died_during,
~if_else(. == "0", "Included", "Excluded due to death during eligibility period")
)) %>%
select(`JCVI Group` = jcvi_group, Status = died_during, everything()) %>%
my_flextable_1()
g <- "02"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
mutate(
across(Characteristic,
~case_when(. %in% "n (% of sample)" ~ "N",
TRUE ~ .))
) %>%
my_flextable_1()
g <- "09"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
mutate(
across(Characteristic,
~case_when(. %in% "n (% of sample)" ~ "N",
TRUE ~ .))
) %>%
my_flextable_1()
g <- "11"
read_csv(here::here("released_outputs", "output", "tables", glue("summary_table_{g}.csv"))) %>%
full_join(
read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
rename(Characteristic = characteristic,
"OR (95% CI)" = OR)
) %>%
mutate(
across(Characteristic,
~case_when(. %in% "n (% of sample)" ~ "N",
TRUE ~ .))
) %>%
my_flextable_1()
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
# filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
left_join(tables_list[["09"]]) %>%
left_join(tables_list[["11"]]) %>%
rename(Characteristic=characteristic) %>%
flextable() %>%
add_header_row(
values = c("", "Odds ratio of JCVI group:"),
colwidths = c(1, 3)) %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
# filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
full_join(tables_list[["09"]]) %>%
full_join(tables_list[["11"]]) %>%
rename(Characteristic=characteristic) %>%
flextable() %>%
add_header_row(
values = c("", "Odds ratio of JCVI group:"),
colwidths = c(1, 3)) %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
tables_list[["02"]] %>%
mutate(order_02=row_number())
theme_vanilla() %>% print(n=Inf)
tables_list[["02"]] %>%
mutate(order_02=row_number()) %>% print(n=Inf)
tables_list[["11"]]
tables_list[["11"]]  %>% print(n=Inf)
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
# filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
mutate(order_02=row_number()) %>%
full_join(tables_list[["09"]]
, by="characteristic") %>%
full_join(tables_list[["11"]] %>%
mutate(order_11 = case_when(
str_detect(characteristic, "^Age group")
~0,
str_detect(characteristic, "^Preg")
~ 60.5,
TRUE ~ .))
, by="characteristic") %>%
rename(Characteristic=characteristic) %>%
mutate(order = if_else(is.na(order_02), order_11, order_02)) %>%
arrange(order) %>%
select(-starts_with("order")) %>%
flextable() %>%
add_header_row(
values = c("", "Odds ratio of JCVI group:"),
colwidths = c(1, 3)) %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
tables_list <- list()
for (g in c("02", "09", "11")) {
tables_list[[g]] <- read_csv(file = here::here("released_outputs", "output", "tables", glue("table_{g}_unadj.csv"))) %>%
# filter(str_detect(characteristic, "COVID")) %>%
rename(!! g := OR)
}
tables_list[["02"]] %>%
mutate(order_02=row_number()) %>%
full_join(tables_list[["09"]]
, by="characteristic") %>%
full_join(tables_list[["11"]] %>%
mutate(order_11 = case_when(
str_detect(characteristic, "^Age group")
~0,
str_detect(characteristic, "^Preg")
~ 60.5,
TRUE ~ NA_real_))
, by="characteristic") %>%
rename(Characteristic=characteristic) %>%
mutate(order = if_else(
is.na(order_02),
order_11,
as.double(order_02)
)) %>%
arrange(order) %>%
select(-starts_with("order")) %>%
flextable() %>%
add_header_row(
values = c("", "Odds ratio of JCVI group:"),
colwidths = c(1, 3)) %>%
fontsize(size=10) %>%
autofit() %>%
theme_vanilla()
